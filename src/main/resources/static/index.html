<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sinh viên</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

    <h3 class="text-center text-primary">HỆ THỐNG QUẢN LÝ SINH VIÊN</h3>

    <div class="card mb-4">
        <div class="card-body">
            <input type="text" id="search" class="form-control" 
                   placeholder="Nhập tên sinh viên để tìm kiếm..." onkeyup="searchStudent()">
        </div>
    </div>

    <table class="table table-hover table-bordered shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Tên</th>
                <th>Email</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="studentTable"></tbody>
    </table>

    <div class="card p-4 shadow-sm">
        <h4 id="formTitle">Thêm sinh viên mới</h4>
        <input type="hidden" id="studentId"> <div class="row">
            <div class="col-md-5">
                <input id="name" class="form-control mb-2" placeholder="Tên sinh viên">
            </div>
            <div class="col-md-5">
                <input id="email" class="form-control mb-2" placeholder="Email">
            </div>
            <div class="col-md-2">
                <button id="btnSave" class="btn btn-primary w-100" onclick="saveStudent()">Lưu</button>
                <button id="btnCancel" class="btn btn-secondary w-100 mt-1 d-none" onclick="resetForm()">Hủy</button>
            </div>
        </div>
    </div>

<script>
const API = "http://localhost:8085/api/students";

// 1. Tải danh sách sinh viên
function loadStudents() {
    fetch(API)
        .then(res => res.json())
        .then(data => renderTable(data));
}

// Hàm bổ trợ hiển thị dữ liệu vào bảng
function renderTable(data) {
    let html = "";
    data.forEach(s => {
        html += `
        <tr>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.email}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editStudent(${s.id}, '${s.name}', '${s.email}')">Sửa</button>
                <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.id})">Xóa</button>
            </td>
        </tr>`;
    });
    document.getElementById("studentTable").innerHTML = html;
}

// 2. Thêm hoặc Cập nhật sinh viên
function saveStudent() {
    const id = document.getElementById("studentId").value;
    const student = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value
    };

    // Nếu có ID thì gọi API Update, ngược lại gọi API Add
    let url = id ? `${API}/update/${id}` : API;
    
    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(student)
    })
    .then(res => {
        if(res.ok) {
            alert(id ? "Cập nhật thành công!" : "Thêm thành công!");
            resetForm();
            loadStudents();
        }
    });
}

// 3. Chuẩn bị dữ liệu để Sửa
function editStudent(id, name, email) {
    document.getElementById("studentId").value = id;
    document.getElementById("name").value = name;
    document.getElementById("email").value = email;
    
    document.getElementById("formTitle").innerText = "Cập nhật sinh viên ID: " + id;
    document.getElementById("btnSave").innerText = "Cập nhật";
    document.getElementById("btnCancel").classList.remove("d-none");
}

// 4. Xóa sinh viên (Đồng bộ với API /delete/{id})
function deleteStudent(id) {
    if(confirm("Bạn có chắc chắn muốn xóa sinh viên này?")) {
        fetch(`${API}/delete/${id}`, { method: "POST" })
            .then(() => loadStudents());
    }
}

// 5. Tìm kiếm (Bài 2 & 3)
function searchStudent() {
    const name = document.getElementById("search").value;
    fetch(`${API}/search?name=${name}`)
        .then(res => res.json())
        .then(data => renderTable(data));
}

// Hàm reset form về trạng thái ban đầu
function resetForm() {
    document.getElementById("studentId").value = "";
    document.getElementById("name").value = "";
    document.getElementById("email").value = "";
    document.getElementById("formTitle").innerText = "Thêm sinh viên mới";
    document.getElementById("btnSave").innerText = "Thêm";
    document.getElementById("btnCancel").classList.add("d-none");
}

loadStudents();
</script>

</body>
</html>